/**
 * Bff.Publicator.js (bff\db\Publicator component)
 * @author Tamaranga | tamaranga.com
 * @version 2.03
 * @cl 71368931f096c93f9c8d1d34980a60dd
 * @modified 24.feb.2018
 */
var bffPublicator=function(){function e(e,r){function o(){U.on("click",".controls a",function(e){var t=$(this).attr("rel"),l=D;switch(t){case"photo":return;case"text":u(i.text,m(i.text,l,a.lang.text_tip,"",a.useWY?"wy":""),!0),h(l).find("textarea:visible").focus();break;case"textmd":u(i.textmd,m(i.textmd,l,a.lang.text_tip,"","markdown"),!0);var r=h(l).find("textarea:visible");r.autogrow({minHeight:60,lineHeight:16}),r.focus();break;case"quote":u(i.quote,m(i.quote,l,a.lang.text_tip,"",a.useWY?"wy":""),!0),h(l).find("textarea:visible").focus();break;case"subtitle":u(i.subtitle,'<div class="subtitle">'+m(i.subtitle,l,a.lang.subtitle_tip,"","no-enter")+g("subtitle-size",l,0)+'<div class="clear"></div></div>',!0),h(l).find("textarea:visible").focus();break;case"video":u(i.video,'<div class="objectBlock">                                        <div class="overflow">'+m(i.video,l,a.lang.video_tip,"","video-url no-enter")+'<input class="btn btn-small button submit video-submit" type="button" rel="'+l+'" value="'+a.lang.video_submit+'" /></div><div class="desc">'+a.lang.video_supported+"</div>                                    </div>",!1),h(l).find("textarea").focus();break;case"gallery":Y[l]={swfu:!1,photos:[],edit:!0,items:null,k:0,dnd:!1,dyn:!0,bytesTotal:!1,uploaded:0,id_start:1},u(i.gallery,'<div>                                <table style="width:100%;"><tbody class="gallery-items"></tbody></table>                                <span class="gallery-item left relative"><span class="gallery-plus grey"><b>+</b></span><br /><a href="javascript:;" class="j-upload-button"><span class="j-percent">'+a.lang.photo_add+"</span></a></span>                                "+g("gallery-inline",D,{})+'                                <div class="clear-all"></div>                            </div>',!0),y(l);break;case"map":u(i.map,'<div class="map-addres">'+m(i.map,l,a.lang.map_tip,"","no-enter j-map-addr")+'<div class="right"><input class="btn btn-small button submit j-map-search" type="button" value="'+a.lang.map_search+'" /></div><div class="clear-all"></div></div><div class="map-container map-google j-map-container"></div>'+g("map",l,{lat:a.map_def_lat,lon:a.map_def_lon}),!0),z(l,!1);break;default:return}nothing(e),H=!1,s(!1),U.triggerHandler("click.controlsBack")}),U.on("focus focusin focusout blur keyup keydown","textarea",function(e){var t=$(this);switch(e.type){case"focus":case"focusin":a.useWY&&t.hasClass("wy")&&w(t.removeClass("wy")),t.addClass("active").next(".tip").addClass("hidden");break;case"blur":case"focusout":t.removeClass("active"),t.val().length&&!t.val().match(/^[\s\r\n]+$/)||t.val("").height(a.textHeight).next(".tip").removeClass("hidden");break;case"keydown":if(t.hasClass("no-enter"))return 13!=e.keyCode;case"keyup":a.useWY&&(a.wyPhoto||!t.hasClass("photo")||t.hasClass("markdown"))||(bff.browser.msie||t.height(a.textHeight),t.height(t[0].scrollHeight))}}),U.on("click",".text-to-wy",function(){var e=$(this).parent().find("textarea").css({height:$(this).height()}).removeClass("wy");a.useWY?w(e):(e.removeClass("hidden"),$(this).hide())}),U.on("click mouseover mouseout","div.tip",function(e){switch(e.type){case"click":$(this).prev().focus();break;case"mouseover":$(this).prev().addClass("hover");break;case"mouseout":$(this).prev().removeClass("hover")}}),U.on("click","div.insert",function(){var e=$("> div.controlsBorder > div.controls",U),t=$(this).closest(".j-block");if(H=intval(t.attr("block-id"))){var a=intval(t.offset().top)-(intval(N.offset().top)+intval(N.height()));e.animate({top:a},500),U.bind("click.controlsBack",function(t){e.animate({top:0},500,function(){U.unbind("click.controlsBack")}),$(t.target).is("input:file")||(H=!1)})}}),U.on("click","div.close",function(){var e=$(this).closest(".j-block"),t=e.attr("block-type"),l=intval(e.attr("block-id"));if(t==i.photo){var r=$("input.photo-content",e);if(!r.length||!r.val())return void f(e);var o=r.val();if(_(o)){if(!confirm(a.lang.del))return;return void bff.ajax(a.url+"img_delete",{photos:[[o,t]],id:a.id},function(t){t&&t.success&&(x(o),f(e))})}}else if(t==i.gallery&&Y[l].dyn){var s=Y[l].photos;if(s.length>0){if(!confirm(a.lang.del))return;var n=[];for(var l in s)n.push([s[l],t]);bff.ajax(a.url+"img_delete",{photos:n,id:a.id},function(t){t&&t.success&&(x(s),delete Y[l],f(e))})}else delete Y[l],f(e);return}(t!=i.photo&&t!=i.gallery||confirm(a.lang.del))&&($(this).parent().append(v(t,l,"del")),f(e,!0))}),R.on("click",'tbody tr[block-type="'+i.video+'"] input.video-submit',function(){var e=intval($(this).attr("rel")),i=$(this).parents(".mask").find("div.objectBlock"),l=i.find("textarea.video-url"),r=l.val()||"";return r.length?void bff.ajax(a.url+"video_validate",{url:r,id:a.id},function(r){r&&(r.correct?i.html(b(r.url,r.source,e,r)):(t(a.lang.video_not_valid),l.focus()))}):(l.focus(),!1)}),s(!1);var e=(new qq.FileUploaderBasic({button:U.find(".controls a.photo").get(0),sizeLimit:a.upload.maxSize,action:a.url+"img_upload&id="+a.id+"&block_type="+i.photo,multiple:!0,allowedExtensions:["jpeg","jpg","png","gif"],onSubmit:function(e,t){return p(e,"start",t)},onProgress:function(e,t,a,i){p(e,"progress",{fileName:t,loaded:a,total:i})},onComplete:function(e,a,i){return i&&i.success?p(e,"preview",i):i.errors&&(t(i.errors),p(e,"remove")),!0},onCancel:function(e){p(e,"remove")},showMessage:function(e){t(e)},messages:{typeError:a.lang.upload_typeError,sizeError:a.lang.upload_sizeError,minSizeError:a.lang.upload_minSizeError,emptyError:a.lang.upload_emptyError,limitError:a.lang.upload_limitError,onLeave:a.lang.upload_onLeave}}),!1);l.bind("beforeunload",function(){!e&&!O&&S.length>0&&(e=!0,bff.ajax(a.url+"img_delete",{photos:S,id:a.id},function(){},!1,{async:!1}))});var r=U.closest("form:first");r.length&&r.submit(function(){O=!0}),M&&(r.find(".j-lang-togglers").length||U.find(".langs").show(),C=U.find(".langs a"),C.click(function(e){nothing(e),j($(this).attr("rel"))}))}function s(e){if(e!==!1&&e>0){var t=e,i=Y[t],r=i.$items.parent();return $('a[rel="pg'+t+'"]',r).fancybox(),void(i.dnd?r.tableDnDUpdate():(void 0!=l.tableDnD&&r.tableDnD({onDragClass:"drag"}),i.dnd=!0))}if(T)$(R).tableDnDUpdate();else{if(void 0==l.tableDnD)return;$(R).tableDnD({dragHandle:".dragger div",onDragClass:"drag",onDrop:function(e,t){if(a.useWY){var i=intval($(t).attr("block-id"));i&&P[i]&&P[i].reinitIframe()}}}),T=!0}}function n(){if(a.m.title){var e=$(".publicatorTitle",U),t=M?{}:e.html();M&&e.find(">div").each(function(){t[$(this).attr("class")]=$(this).html()}),e.html(m(i.title,0,a.lang.title,t,"no-enter")).removeClass("hidden")}var l=!1,r="";$(".publicatorData > div",U).each(function(e){var t=[];$(">div",this).each(function(){var e=$(this),a=e.attr("class");!M||"text"!=a&&"inline_text"!=a?t[a]=e.html():(t[a]={},e.find(">div").each(function(){t[a][$(this).attr("class")]=$(this).html()}))});var o=intval(t.type);switch(o){case i.text:case i.quote:r+=u(o,m(o,D,a.lang.text_tip,t.text,a.useWY?"hidden wy":""),!0,'<div class="edit"></div>',!0);break;case i.textmd:r+=u(o,m(o,D,a.lang.text_tip,t.text,"markdown"),!0,"",!0);break;case i.photo:r+=u(o,'<table width="100%">                                   <tr>                                     <td width="165"><div class="photo-progress"><img src="'+t.url_t+'" /></div></td>                                     <td valign="top">                                        <div class="photo-text">'+m(o,D,a.lang.photo_tip,t.text,a.wyPhotos?"hidden wy":"")+"</div>                                        "+g("photo-align",D,t.align)+"                                        "+g("photo-zoom",D,t.zoom)+'                                        <div class="clear"></div>                                     </td>                                   </tr></table>                                   <input type="hidden" name="'+v(o,D,!1)+'" value="'+t.photo+'" class="photo-content" />                                   <input type="hidden" name="'+v(!1,D,"view")+'" value="'+t.view+'" />                                 ',!0,'<div class="edit"></div>',!0);break;case i.gallery:var e=D,s=$.parseJSON(t.photos),n=[],d="",c=1,p="",h="";for(var f in s)d=s[f].photo,n.push(d),p+='<tr class="j-gallery-item-block"><td><span class="gallery-item">                                <input type="hidden" name="'+v(o,e,!1,"[p]["+c+"]")+'" class="photo-content" value="'+d+'" />                                <a href="'+s[f].url.v+'" rel="pg'+e+'"><img src="'+s[f].url.t+'" /></a>                            </span>                            <div class="gallery-edit">                               '+m(o,e,a.lang.photo_tip,s[f].text,"",{fieldnameExtra:"[p]["+c+"]"})+'<br /><br />                                <a href="#" class="ajax desc ph_del" rel="'+c+'">'+a.lang.photo_del+'</a>                            </div><div class="clear-all"></div></td></tr>',h+='<span class="gallery-item"><a href="'+s[f].url.v+'" rel="pg'+e+'"><img src="'+s[f].url.t+'" /></a></span>',c++;r+=u(o,'<div class="pg-edit displaynone"><table style="width:100%;"><tbody class="gallery-items">'+p+'</tbody></table>                                <span class="gallery-item left relative"><span class="gallery-plus grey"><b>+</b></span><br /><a href="javascript:;" class="j-upload-button"><span class="j-percent">'+a.lang.photo_add+"</span></a></span>                                "+g("gallery-inline",D,t)+'                                <div class="clear-all"></div></div>                                <div class="pg-view"><div class="gallery-items">'+h+'</div><div class="clear-all"></div></div>',!0,'<div class="edit"></div>',!0),Y[e]={swfu:!1,photos:n,data:s,edit:!1,items:null,id_start:c,k:c,dnd:!1,dyn:!1,bytesTotal:!1,uploaded:n.length},l=!0;break;case i.video:r+=u(o,b(t.video,t.source,D,t),!1,"",!0);break;case i.subtitle:r+=u(o,'<div class="subtitle">'+m(o,D,a.lang.subtitle_tip,t.text,"no-enter")+g("subtitle-size",D,t.size)+'<div class="clear"></div></div>',!0,"",!0);break;case i.map:r+=u(o,'<div class="j-view"><img src="'+t["static"]+'"></div><div class="j-edit displaynone"><div class="map-addres">'+m(i.map,D,a.lang.map_tip,t.text,"no-enter j-map-addr")+'<div class="right"><input class="btn btn-small button submit j-map-search" type="button" value="'+a.lang.map_search+'" /></div><div class="clear-all"></div></div><div class="map-container map-google j-map-container"></div></div>'+g("map",D,{lat:t.lat,lon:t.lon}),!0,'<div class="edit"></div>',!0)}}),R.append("<tbody>"+r+"</tbody>"),setTimeout(function(){$("td.action > div.edit",U).click(function(){var e=$(this).closest(".j-block");e.attr("block-type");switch(intval(e.attr("block-type"))){case i.text:case i.quote:case i.photo:var t=e.find(".text-to-wy");t.length&&!t.hasClass("hidden")&&($(this).hide(),t.click());break;case i.gallery:y(intval(e.attr("block-id")));break;case i.map:z(intval(e.attr("block-id")),!0)}}),l&&$('.j-block[block-type="'+i.gallery+'"] div.pg-view a[rel^="pg"]',U).fancybox(),$("textarea.markdown",U).autogrow({minHeight:60,lineHeight:16})},1),a.debug||$(".publicatorData",U).remove(),$(".j-block textarea",U).each(function(e,t){$(t).height(t.scrollHeight>0?t.scrollHeight:20)})}function d(e){for(var t in P)P[t].sync();S=[],e&&e.length>0}function c(e){return Math.round(e/1024*100)/100+" Kb"}function p(e,t,l){switch(t){case"start":var r=D;u(i.photo,'<table style="width:98%"><tr><td width="165"><div class="photo-progress">                            <div class="progress-title">                               <div class="progress-cell"><div>'+l+'<br /><span class="j-size"></span></div></div>                                  </div>                                  <div class="progress-bg"></div>                               </div></td>                               <td valign="top">                                    <div class="photo-text">'+m(i.photo,r,a.lang.photo_tip,"")+v(i.photo,r,"type")+"</div>                                    "+g("photo-align",r,"center")+"                                    "+g("photo-zoom",r,0)+'                                    <div class="clear"></div>                               </td>                               </tr></table>',!1),W[e]={i:r,block:h(r)},H&&(H=r),s(!1);break;case"progress":var o=W[e],n=166;o.block.find(".j-size").text(c(l.total)),n=n/100*Math.ceil(l.loaded/l.total*100),$("div.progress-bg",o.block).stop().animate({width:n});break;case"preview":var o=W[e];$("div.photo-progress",o.block).html('<img src="'+l.t+'" />').append('<input type="hidden" name="'+v(i.photo,o.i,!1)+'" class="photo-content" value="'+l.filename+'" />').append('<input type="hidden" name="'+v(!1,o.i,"view")+'"  value="'+l.view+'" />'),S.push([l.filename,i.photo]);var d=$("textarea:visible",o.block);a.wyPhotos?w(d):d.focus();break;case"remove":W[e]&&(f(W[e].block),s(!1))}}function v(e,t,a,l){if(a=a||!1,l=l||"",a)return"type"==a||"del"==a?'<input type="hidden" name="'+q+"[b]["+t+"]"+l+"["+a+']" value="'+e+'" />':q+"[b]["+t+"]"+l+"["+a+"]";switch(e){case i.title:return q+"[t]";case i.text:return q+"[b]["+t+"]"+l+"[text]";case i.textmd:return q+"[b]["+t+"]"+l+"[text]";case i.quote:return q+"[b]["+t+"]"+l+"[text]";case i.photo:return q+"[b]["+t+"]"+l+"[photo]";case i.gallery:return q+"[b]["+t+"]"+l+"[photo]";case i.video:return q+"[b]["+t+"]"+l+"[video]"}return""}function u(e,t,i,l,r){var o=D++;i===!0&&(t+=v(e,o,"type"));var s='<tr id="pblock-'+o+'" class="j-block" block-id="'+o+'" block-type="'+e+'">                            <td class="dragger" align="left" valign="middle"><div class="adragger"><!--//--></div></td>                            <td><div class="mask">'+t+'<div class="mask-top"><div class="insert">'+a.lang.insert+'</div></div><div class="mask-bottom"><!--//--></div><div class="clear"><!--//--></div></div></td>                            <td class="action" align="right" valign="middle">'+(l||"")+'<div class="close"></div></td>                        </tr>';return r===!0?s:(H?h(H).before(s):R.append(s),o)}function h(e){return R.find("#pblock-"+e)}function m(e,t,l,r,o,s,n){if(n=n||"",s=s||{},M&&e!=i.video&&!n.length){if(!$.isPlainObject(r)&&r.length>0&&0==r.indexOf("{")&&(r=$.parseJSON(r)),!$.isPlainObject(r)){r={};for(var d in a.langs)r[a.langs[d]]=""}var c="";for(var d in a.langs){var p=a.langs[d];c+='<div class="'+p+(L!=p?" hidden":"")+'">'+m(e,t,l,r[p],o,s,p)+"</div>"}return c}r=r||"";var u=!r.length;o=o||"";var h="";switch(e){case i.title:case i.subtitle:h+="resize:none;";break;case i.photo:case i.gallery:o+=" photo",h+=" width:100%;";break;case i.text:h+=" width:99%;";break;case i.textmd:h+=" width:99%; min-height:60px;"}var g=v(e===i.title?i.title:i.text,t,!1,s.hasOwnProperty("fieldnameExtra")?s.fieldnameExtra:"");s.hasOwnProperty("fieldname")&&(g=s.fieldname);var c='<textarea name="'+g+(""!=n?"["+n+"]":"")+'" id="publicator-text-'+t+(""!=n?"-"+n:"")+'" '+(o.length?' class="'+o+'"':"")+(""!=h?' style="'+h+'"':"")+' placeholder="'+l+'">'+r+"</textarea>";return a.useWY&&(e==i.photo&&a.wyPhotos||e==i.text||e==i.quote)&&(c+='<div class="text-to-wy'+(e==i.quote?" quote":"")+(u?" tip":"")+'">'+r+(u?l:"")+"</div>"),c}function g(e,t,l){switch(e){case"photo-align":if(!a.m.photo_align)break;var r=[["left","слева"],["center","по-центру"],["right","справа"]],o=v(!1,t,"align"),s="";for(var n in r)s+='<label><input type="radio" name="'+o+'" '+(l==r[n][0]?'checked="checked"':"")+' value="'+r[n][0]+'" /> '+r[n][1]+"</label>";return'<div class="photo-align">'+s+"</div>";case"photo-zoom":if(!a.m.photo_zoom)break;return'<div class="photo-zoom"><label class="checkbox"><input type="checkbox" name="'+v(!1,t,"zoom")+'" '+(1==l?'checked="checked"':"")+" /> zoom</label></div>";case"gallery-inline":if(!a.m.gallery_inline)break;var d="",c=l&&l.hasOwnProperty("inline_link")?l.inline_link>0:!1;d+='<div class="gallery-inline-link"><label class="checkbox"><input type="checkbox" name="'+v(!1,t,"inline_link")+'" '+(c?'checked="checked"':"")+" /> "+a.lang.gallery_inline_link+"</label></div>";var p=l&&l.hasOwnProperty("inline_text")?l.inline_text:{};return d+=m(i.gallery,t,a.lang.gallery_inline_text,p,"no-enter",{fieldname:v(!1,t,"inline_text","")}),'<div class="left" style="margin-left:10px; margin-top:5px; width: 85%;">'+d+"</div>";case"subtitle-size":l=intval(l);var u=[2,3,4,5,6],h="";for(var n in u)h+='<option value="'+u[n]+'"'+(u[n]===l?" selected":"")+">H"+u[n]+"</option>";return'<div class="size"><select name="'+v(!1,t,"size")+'">'+h+"</select></div>";case"map":return'<input type="hidden" name="'+(q+"[b]["+t+"][lat]")+'" class="j-map-lat" value="'+l.lat+'"><input type="hidden" name="'+(q+"[b]["+t+"][lon]")+'" class="j-map-lon" value="'+l.lon+'">'}return""}function f(e,t){e.find(".mask").animate({opacity:"toggle",height:"toggle"},600,function(){t?e.addClass("displaynone"):e.remove()})}function b(e,t,a,l){var r="";return r+='<input name="'+(q+"[b]["+a+"][source]")+'" type="hidden" value="'+t+'" class="video-source" />',l&&l.hasOwnProperty("embed")&&(r+='<input name="'+(q+"[b]["+a+"][embed]")+'" type="hidden" value="'+l.embed+'" class="video-embed-url" />'),l&&l.hasOwnProperty("thumb")&&(r+='<input name="'+(q+"[b]["+a+"][thumb]")+'" type="hidden" value="'+l.thumb+'" class="video-thumb-url" />'),"vk"==t?(-1==e.indexOf("video_ext.php")&&(e="http://vk.com/video_ext.php?"+e),'<div align="center"><iframe src="'+e+'" width="640" height="363" frameborder="0"></iframe>'+r+'                             <textarea name="'+v(i.video,a,!1)+'" style="display:none;" class="video-content">'+e+"</textarea>                             "+v(i.video,a,"type")+"</div>"):'<div align="center">                            <object width="640" height="363">                                <param name="allowfullscreen" value="true" />                                <param name="allowscriptaccess" value="always" />                                <param name="wmode" value="transparent" />                                <param name="movie" value="'+e+'" />                                <embed src="'+e+'" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" wmode="transparent" width="640" height="363"></embed>                            </object>'+r+'                            <textarea name="'+v(i.video,a,!1)+'" style="display:none;" class="video-content">'+e+"</textarea>                            "+v(i.video,a,"type")+"                        </div>"}function y(e){var l=Y[e],r=h(e);l.$items=$(".gallery-items:first",r),l.edit||($(".pg-view",r).remove(),$(".pg-edit",r).removeClass("displaynone"),$("td.action .edit",r).remove(),$("textarea",r).each(function(e,t){$(t).height(t.scrollHeight>0?t.scrollHeight:20)}),s(e),s(!1),l.edit=!0),l.process=0,l.progress={},l.uploader=new qq.FileUploaderBasic({button:r.find(".j-upload-button").get(0),limit:a.m.gallery_photos_limit,sizeLimit:a.upload.maxSize,uploaded:l.uploaded,action:a.url+"img_upload&id="+a.id+"&block_type="+i.gallery,multiple:!0,allowedExtensions:["jpeg","jpg","png","gif"],onSubmit:function(t,a){return k(e,t+l.id_start,"start",a)},onProgress:function(t,a,i,l){k(e,t,"progress",{fileName:a,loaded:i,total:l})},onComplete:function(a,i,r){return r&&r.success?k(e,a+l.id_start,"preview",r):r.errors&&(t(r.errors),k(e,a+l.id_start,"remove")),!0},onCancel:function(t){k(e,t+l.id_start,"remove")},showMessage:function(e){t(e)},messages:{typeError:a.lang.upload_typeError,sizeError:a.lang.upload_sizeError,minSizeError:a.lang.upload_minSizeError,emptyError:a.lang.upload_emptyError,limitError:a.lang.upload_limitError,onLeave:a.lang.upload_onLeave}}),l.$status=r.find(".j-percent"),l.$items.delegate("tr a.ph_del","click",function(){if(!confirm(a.lang.del))return!1;var t=$(this).closest(".j-gallery-item-block"),r=$(".photo-content",t).val();return _(r)?bff.ajax(a.url+"img_delete",{photos:[[r,i.gallery]],id:a.id},function(e){if(e&&e.success){if(x(r),l.uploader.decrementUploaded(),l.photos.length)for(var a in l.photos)if(l.photos[a]==r){l.photos.splice(a,1);break}t.remove()}}):($(this).parent().append(v(i.gallery,e,"del","[p]["+$(this).attr("rel")+"]")),t.hide(),l.uploader.decrementUploaded()),!1})}function k(e,t,l,r){var o=h(e);switch(l){case"start":Y[e].process++;break;case"progress":var n=Y[e];n.progress[t]=r;var d=0,c=0;for(var p in n.progress)n.progress.hasOwnProperty(p)&&(d+=n.progress[p].loaded,c+=n.progress[p].total);var u=d>0?Math.ceil(d/c*100):0;n.$status.html((u>=100?100:u)+"%");break;case"preview":var n=Y[e];n.$items.append('<tr class="j-gallery-item-block"><td><span class="gallery-item">                            <input type="hidden" name="'+v(i.gallery,e,!1,"[p]["+t+"]")+'" class="photo-content" value="'+r.filename+'" />                            <a href="'+r.v+'" rel="pg'+e+'"><img src="'+r.t+'" /></a>                        </span>                        <div class="gallery-edit">                           '+m(i.gallery,e,a.lang.photo_tip,"","",{fieldnameExtra:"[p]["+t+"]"})+'<br /><br />                            <a href="#" class="ajax desc ph_del" rel="'+t+'">'+a.lang.photo_del+'</a>                        </div><div class="clear-all"></div></td></tr>'),S.push([r.filename,i.gallery]),n.photos.push(r.filename),n.process--,n.process<=0&&(n.process=0,n.$status.html(a.lang.photo_add),n.progress={}),s(e);break;case"remove":n.process--,n.process<=0&&(n.process=0,n.$status.html(a.lang.photo_add),n.progress={})}o.find(".j-gallery-sortable").sortable("refresh")}function _(e){for(var t in S)if(S[t][0]==e)return!0;return!1}function x(e){if(e.length&&S.length)if($.isArray(e))for(var t in S)for(var a in e)S[t][0]==e[a]&&S.splice(t,1);else for(var t in S)if(S[t][0]==e){S.splice(t,1);break}}function w(e){e=$(e);var t=e.closest(".j-block"),i=intval(t.attr("block-id"));t.find(".tip,.text-to-wy").addClass("hidden"),t.find(".action .edit").remove(),P[i]=e.bffWysiwyg({controls_hide:["fullscreen","indent","outdent"],reformator:a.useReformator},!0),P[i].focus(!0)}function j(e){e!==L&&(U.find("."+L).toggleClass("hidden"),U.find("."+e).toggleClass("hidden"),a.useWY&&U.find("textarea.wy").each(function(){$(this).parent().parent().find("textarea:not(.wy)").length&&w($(this).removeClass("wy"))}),a.wyPhotos&&U.find("div.photo-text textarea:visible").each(function(){w(this)}),L=e,C.removeClass("active").filter('[rel="'+L+'"]').addClass("active"))}function z(e,t){var a=h(e);if(!B[e]||!B[e].init){t&&(a.find(".j-view").remove(),a.find(".j-edit").removeClass("displaynone"),a.find("td.action .edit").remove(),a.find("textarea").each(function(e,t){$(t).height(t.scrollHeight>0?t.scrollHeight:20)})),B[e]={init:1,$addr:a.find(".j-map-addr"),$lat:a.find(".j-map-lat"),$lon:a.find(".j-map-lon")};var i=B[e];B[e].map=bff.map.init(a.find(".j-map-container").get(0),[i.$lat.val(),i.$lon.val()],function(t){B[e].mapEditor=bff.map.editor(),B[e].mapEditor.init({map:t,version:"2.1",coords:[i.$lat,i.$lon],onAddress:function(e){i.$addr.filter(":visible:first").val(e)},addressKind:!1})},{zoom:13}),a.on("click",".j-map-search",function(t){t.preventDefault(),E(e)})}}function E(e){if(B[e]&&B[e].init){var t=B[e],a=$.trim(t.$addr.filter(":visible:first").val());a&&t.lastQuery!=a&&t.mapEditor.search(t.lastQuery=a,!1,function(){t.mapEditor.centerByMarker()})}}r&&$.extend(a,r||{});var C,P=[],D=1,H=!1,q="pdata",O=!1,S=[],W=[],Y={},B={},L=!1,M=!1,T=!1;a.fieldname&&(q=a.fieldname),a.m.use_wysiwyg?(a.m.photo_wysiwyg||(a.wyPhotos=!1),a.m.use_reformator&&(a.useReformator=!0)):a.useWY=a.wyPhotos=!1,a.langs!==!1&&(M=!0,L=a.langs_cur);var U=$(e)||null;if(!U)return t(a.lang.init_error);var N=U.find(".canvas"),R=U.find("table.publicatorBlocks");return n(),setTimeout(o,0),{getContainer:function(){return U},ajaxSave:d,setLang:j}}function t(e,t,a){return bff.error?bff.error(e,{success:!!t,append:!!a}):alert(e),!1}var a={m:{name:"",photo_wysiwyg:!1,photo_align:!1,photo_zoom:!1,gallery_photos_limit:0,gallery_inline:!1},url:"",id:0,title:!0,useWY:!0,useReformator:!1,wyPhotos:!0,langs:!1,textHeight:20,upload:{maxSize:"8 MB"},debug:!1,lang:{init_error:"Ошибка инициализации",title:"Заголовок",title_empty:"Укажите текст заголовка",del:"Удалить?",text_tip:"Добавить текст",subtitle_tip:"Подзаголовок",images_all:"Все изображения",photo_tip:"Без описания",photo_del:"удалить фото",photo_add:"добавить фото",gallery_inline_link:"Встроенная ссылка",gallery_inline_text:"Текст встроенной ссылки",video_tip:"Укажите ссылку на видео",video_supported:"Поддерживаются: YouTube, Vimeo, RuTube, Vkontakte",video_submit:"Готово",video_not_valid:"Неверный формат ссылки",insert:"",upload_typeError:"Допустимы только следующие типы файлов: {extensions}",upload_sizeError:"Файл {file} слишком большой, максимально допустимый размер {sizeLimit}",upload_minSizeError:"Файл {file} имеет некорректный размер",upload_emptyError:"Файл {file} имеет некорректный размер",upload_limitError:"Вы можете загрузить не более {limit} файлов",upload_onLeave:"Происходит загрузка изображения, если вы покинете эту страницу, загрузка будет прекращена"}},i={title:0,text:1,photo:2,video:3,subtitle:4,gallery:5,quote:6,map:7,textmd:8},l=$(window);return{init:e}}();